<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Payment - CincoAcademy</title>
    <link rel="stylesheet" href="../css/styles.css?v=8">
    <style>
        .payment-box {
            max-width: 480px;
            margin: 40px auto;
            padding: 24px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

            .payment-box h2 {
                margin-bottom: 12px;
                color: var(--primary-navy, #0a2e5d);
            }

            .payment-box p {
                margin-bottom: 16px;
                font-size: 14px;
                color: #555;
            }

        .form-group {
            margin-bottom: 16px;
        }

            .form-group label {
                display: block;
                margin-bottom: 6px;
                font-weight: 600;
            }

            .form-group input {
                width: 100%;
                padding: 10px;
                border-radius: 8px;
                border: 1px solid #ccc;
            }

        .btn-submit {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(90deg, var(--primary-navy,#0a2e5d), var(--teal,#00b3a4));
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="header"></div>
    <main class="container" role="main">
        <div id="sidebar"></div>

        <div class="payment-box">
            <h2>Course Enrollment Payment</h2>
            <p>
                برجاء التحويل عبر <strong>Instapay</strong> على الرقم التالي:
                <strong style="color:#0a2e5d">01067977217</strong><br>
                بعد التحويل قم بإدخال رقم الهاتف المرسل منه ورفع صورة (Screenshot) لعملية التحويل.
            </p>

            <form id="paymentForm">
                <div class="form-group">
                    <label for="phone">رقم الهاتف المحول منه <span style="color:red">*</span></label>
                    <input type="text" id="phone" name="phone" required placeholder="مثال: 01012345678">
                </div>

                <div class="form-group">
                    <label for="screenshot">Screenshot التحويل <span style="color:red">*</span></label>
                    <input type="file" id="screenshot" name="screenshot" accept="image/*" required>
                </div>

                <!-- Hidden CourseId field -->
                <input type="hidden" id="courseId" name="courseId" required>

                <button type="submit" class="btn-submit">إرسال</button>
            </form>
        </div>

        <script>
            // التحقق من تسجيل الدخول (مثال: بناء على JWT أو session)
            const token = localStorage.getItem("token");
            const studentId = localStorage.getItem("studentId"); // لازم يتخزن بعد الـ Login

            if (!token || !studentId) {
                window.location.href = "login.html"; // لو مش عامل Login يروح للتسجيل
            }

            // Get courseId from query string
            function getQueryParam(name) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(name);
            }

            const courseId = getQueryParam("courseId");
            if (!courseId) {
                alert("يجب تحديد رقم الكورس (CourseId) في الرابط.");
                window.location.href = "Courses.html";
            } else {
                document.getElementById("courseId").value = courseId;
            }

            // دالة تجيب بيانات الكورس
            async function getCourse(courseId) {
                const response = await fetch(`https://localhost:44380/api/Course/${courseId}`);
                if (!response.ok) {
                    throw new Error("تعذر تحميل بيانات الكورس");
                }
                return await response.json();
            }

            // معالجة الفورم
            document.getElementById("paymentForm").addEventListener("submit", async (e) => {
                e.preventDefault();

                try {
                    // هات بيانات الكورس الأول
                    const course = await getCourse(courseId);

                    const formData = new FormData(e.target);

                    // أضف StudentId و CourseId و CoursePrice للـ FormData
                    formData.append("StudentId", studentId);
                    formData.append("CourseId", courseId);
                    formData.append("CoursePrice", course.price);

                    // Debug log عشان تتأكد
                    for (let pair of formData.entries()) {
                        console.log(pair[0] + ": " + pair[1]);
                    }

                    const response = await fetch("https://localhost:44380/api/Payments", {
                        method: "POST",
                        body: formData
                    });

                    if (response.ok) {
                        alert("تم إرسال بيانات الدفع بنجاح! سيتم تفعيل الكورس بعد المراجعة ✅");
                        window.location.href = "Courses.html";
                    } else {
                        const errorText = await response.text();
                        console.error("Server error:", errorText);
                        alert("حصل خطأ أثناء الإرسال ❌\n" + errorText);
                    }
                } catch (err) {
                    console.error(err);
                    alert("خطأ في الاتصال بالسيرفر ❌");
                }
            });
        </script>

    </main>
    <script>
        async function loadComponent(id, file) {
            const response = await fetch(file);
            const html = await response.text();
            document.getElementById(id).innerHTML = html;
        }
        loadComponent("header", "header.html");
        loadComponent("sidebar", "sidebar.html");
    </script>
</body>
</html>